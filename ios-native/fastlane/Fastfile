# Intok iOS Fastlane Configuration
# This file contains the fastlane.tools configuration

default_platform(:ios)

# Constants
APP_IDENTIFIER = "com.intokapp.app"
APP_NAME = "Intok"
XCODE_PROJECT = "Intok.xcodeproj"
SCHEME = "Intok"

platform :ios do
  
  # ============================================
  # Setup & Configuration
  # ============================================
  
  desc "Install certificates and provisioning profiles"
  lane :setup_signing do
    # Using match for certificate management (recommended)
    # First time setup: run `fastlane match init` to configure
    if ENV["MATCH_GIT_URL"]
      match(
        type: "appstore",
        app_identifier: APP_IDENTIFIER,
        readonly: true
      )
    else
      UI.important("MATCH_GIT_URL not set. Manual certificate import required.")
    end
  end

  # ============================================
  # Build Lanes
  # ============================================
  
  desc "Build debug version for simulators"
  lane :build_debug do
    gym(
      project: XCODE_PROJECT,
      scheme: SCHEME,
      configuration: "Debug",
      export_method: "development",
      skip_archive: true,
      destination: "platform=iOS Simulator,name=iPhone 15"
    )
  end

  desc "Build release version for TestFlight/App Store"
  lane :build_release do
    # Increment build number
    increment_build_number(
      build_number: ENV["BUILD_NUMBER"] || Time.now.strftime("%Y%m%d%H%M")
    )
    
    # Build and archive
    gym(
      project: XCODE_PROJECT,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Intok.ipa",
      clean: true
    )
  end

  # ============================================
  # Deployment Lanes
  # ============================================
  
  desc "Deploy to TestFlight (Internal Testing)"
  lane :deploy_testflight do
    # Build first
    build_release
    
    # Upload to TestFlight
    pilot(
      app_identifier: APP_IDENTIFIER,
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false
    )
    
    UI.success("✅ Build uploaded to TestFlight!")
  end

  desc "Deploy to App Store (Production)"
  lane :deploy_appstore do
    # Build first
    build_release
    
    # Upload to App Store Connect
    deliver(
      app_identifier: APP_IDENTIFIER,
      submit_for_review: false,
      automatic_release: false,
      force: true,
      skip_screenshots: true,
      skip_metadata: true
    )
    
    UI.success("✅ Build uploaded to App Store Connect!")
  end

  # ============================================
  # Utility Lanes
  # ============================================
  
  desc "Run tests"
  lane :test do
    scan(
      project: XCODE_PROJECT,
      scheme: SCHEME,
      devices: ["iPhone 15"],
      clean: true
    )
  end

  desc "Increment version number"
  lane :bump_version do |options|
    bump_type = options[:type] || "patch"
    increment_version_number(bump_type: bump_type)
    
    version = get_version_number
    UI.success("✅ Version bumped to #{version}")
  end

  desc "Create new app on App Store Connect"
  lane :create_app do
    produce(
      app_identifier: APP_IDENTIFIER,
      app_name: APP_NAME,
      language: "English",
      app_version: "1.0.0",
      sku: "com.intokapp.app"
    )
  end

  # ============================================
  # Error Handling
  # ============================================
  
  error do |lane, exception|
    UI.error("❌ Lane '#{lane}' failed with error: #{exception.message}")
  end
end


