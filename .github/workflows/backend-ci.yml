name: âš¡ Backend CI/CD

on:
  push:
    branches: [dev, stage, main]
    paths:
      - 'server-serverless/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [dev, stage, main]
    paths:
      - 'server-serverless/**'
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to AWS'
        required: false
        default: false
        type: boolean

concurrency:
  group: backend-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: us-east-1
  STACK_NAME: lingualink
  NODE_VERSION: '18'

jobs:
  # ============================================
  # CODE QUALITY: Lint, Type Check, Security
  # ============================================
  code-quality:
    name: ðŸ§¹ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        working-directory: ./server-serverless
        run: npm install

      - name: ðŸ” TypeScript Check
        working-directory: ./server-serverless
        run: npx tsc --noEmit

      - name: ðŸ§¹ ESLint Check
        working-directory: ./server-serverless
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            npx eslint src/ --ext .ts --max-warnings 20
          else
            echo "âš ï¸ No ESLint config found, skipping..."
          fi
        continue-on-error: true

      - name: ðŸ”’ Security Audit
        working-directory: ./server-serverless
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: ðŸ“Š Code Quality Summary
        run: |
          echo "## ðŸ§¹ Backend Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | âœ… Checked |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | âœ… Checked |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # BUILD & VALIDATE
  # ============================================
  build:
    name: ðŸ”¨ Build & Validate
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        working-directory: ./server-serverless
        run: npm install

      - name: ðŸ—ï¸ Build TypeScript
        working-directory: ./server-serverless
        run: npm run build

      - name: ðŸ”§ Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: âœ… Validate SAM Template
        working-directory: ./server-serverless
        run: sam validate --lint

      - name: ðŸ“¦ SAM Build
        working-directory: ./server-serverless
        run: sam build

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## âœ… Backend Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Compile | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| SAM Validate | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| SAM Build | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # DEPLOY TO AWS (Only on dev branch or manual)
  # ============================================
  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/dev') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        working-directory: ./server-serverless
        run: npm install

      - name: ðŸ—ï¸ Build TypeScript
        working-directory: ./server-serverless
        run: npm run build

      - name: ðŸ”§ Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“¦ SAM Build
        working-directory: ./server-serverless
        run: sam build

      - name: ðŸš€ SAM Deploy
        working-directory: ./server-serverless
        env:
          AI_PROVIDER: ${{ secrets.AI_PROVIDER || 'openai' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          # Push notification credentials (reusing existing Apple secrets)
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          FCM_SERVER_KEY: ${{ secrets.FCM_SERVER_KEY }}
        run: |
          # Validate required secrets
          if [ -z "${JWT_SECRET}" ]; then
            echo "âŒ Error: JWT_SECRET secret is not set in GitHub repository secrets"
            echo "Please add JWT_SECRET to your repository secrets before deploying"
            exit 1
          fi
          
          # Build parameter overrides dynamically (skip empty values)
          PARAMS="JwtSecret=${JWT_SECRET} AIProvider=${AI_PROVIDER}"
          
          if [ -n "${OPENAI_API_KEY}" ]; then
            PARAMS="${PARAMS} OpenAIApiKey=${OPENAI_API_KEY}"
          fi
          
          if [ -n "${ANTHROPIC_API_KEY}" ]; then
            PARAMS="${PARAMS} AnthropicApiKey=${ANTHROPIC_API_KEY}"
          fi
          
          if [ -n "${DEEPSEEK_API_KEY}" ]; then
            PARAMS="${PARAMS} DeepSeekApiKey=${DEEPSEEK_API_KEY}"
          fi
          
          # Push notification params (iOS APNs - reusing App Store Connect credentials)
          if [ -n "${APPLE_TEAM_ID}" ]; then
            PARAMS="${PARAMS} AppleTeamId=${APPLE_TEAM_ID}"
          fi
          
          if [ -n "${APP_STORE_CONNECT_API_KEY_ID}" ]; then
            PARAMS="${PARAMS} AppStoreConnectApiKeyId=${APP_STORE_CONNECT_API_KEY_ID}"
          fi
          
          if [ -n "${APP_STORE_CONNECT_API_KEY}" ]; then
            PARAMS="${PARAMS} AppStoreConnectApiKey=${APP_STORE_CONNECT_API_KEY}"
          fi
          
          # Push notification params (Android FCM)
          if [ -n "${FCM_SERVER_KEY}" ]; then
            PARAMS="${PARAMS} FcmServerKey=${FCM_SERVER_KEY}"
          fi
          
          sam deploy \
            --stack-name ${{ env.STACK_NAME }} \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides ${PARAMS}

      - name: ðŸ“‹ Get Stack Outputs
        run: |
          echo "## ðŸš€ Backend Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Stack | \`${{ env.STACK_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Endpoints:" >> $GITHUB_STEP_SUMMARY
          aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue]' \
            --output text | while read key value; do
              echo "- **$key**: \`$value\`" >> $GITHUB_STEP_SUMMARY
          done
