name: ðŸ” Setup Push Notification Secrets

# This is a one-time setup workflow to create AWS Secrets Manager secrets
# from GitHub secrets. Run manually once, then can be deleted.

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "create-secrets" to confirm'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  setup-secrets:
    name: ðŸ” Create AWS Secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'create-secrets'
    
    steps:
      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“± Create APNs Secret
        env:
          APNS_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APNS_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APNS_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          # Check if secret exists
          if aws secretsmanager describe-secret --secret-id "intok/push/apns" 2>/dev/null; then
            echo "ðŸ”„ Updating existing APNs secret..."
            aws secretsmanager put-secret-value \
              --secret-id "intok/push/apns" \
              --secret-string "{\"keyId\":\"${APNS_KEY_ID}\",\"teamId\":\"${APNS_TEAM_ID}\",\"privateKey\":$(echo "$APNS_PRIVATE_KEY" | jq -Rs .)}"
          else
            echo "âœ¨ Creating new APNs secret..."
            aws secretsmanager create-secret \
              --name "intok/push/apns" \
              --description "APNs credentials for iOS push notifications" \
              --secret-string "{\"keyId\":\"${APNS_KEY_ID}\",\"teamId\":\"${APNS_TEAM_ID}\",\"privateKey\":$(echo "$APNS_PRIVATE_KEY" | jq -Rs .)}"
          fi
          echo "âœ… APNs secret configured"

      - name: ðŸ¤– Create FCM Secret
        env:
          FCM_SERVICE_ACCOUNT: ${{ secrets.FCM_SERVICE_ACCOUNT }}
          FCM_PROJECT_ID: ${{ secrets.FCM_PROJECT_ID }}
        run: |
          # Build the secret JSON
          # The serviceAccount needs to be stored as a JSON object, not a string
          SECRET_VALUE=$(jq -n \
            --arg projectId "${FCM_PROJECT_ID:-lingualink-479903}" \
            --argjson serviceAccount "$FCM_SERVICE_ACCOUNT" \
            '{projectId: $projectId, serviceAccount: $serviceAccount}')
          
          # Check if secret exists
          if aws secretsmanager describe-secret --secret-id "intok/push/fcm" 2>/dev/null; then
            echo "ðŸ”„ Updating existing FCM secret..."
            aws secretsmanager put-secret-value \
              --secret-id "intok/push/fcm" \
              --secret-string "$SECRET_VALUE"
          else
            echo "âœ¨ Creating new FCM secret..."
            aws secretsmanager create-secret \
              --name "intok/push/fcm" \
              --description "FCM credentials for Android push notifications" \
              --secret-string "$SECRET_VALUE"
          fi
          echo "âœ… FCM secret configured"

      - name: ðŸ“‹ Summary
        run: |
          echo "## ðŸ” Push Notification Secrets Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`intok/push/apns\` | âœ… Created |" >> $GITHUB_STEP_SUMMARY
          echo "| \`intok/push/fcm\` | âœ… Created |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can now deploy the backend and push notifications will work!" >> $GITHUB_STEP_SUMMARY
