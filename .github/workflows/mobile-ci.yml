name: ðŸ“± Mobile App CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'mobile/**'
  workflow_dispatch:
    inputs:
      deploy_to_stores:
        description: 'Deploy to Play Store & TestFlight'
        required: false
        default: false
        type: boolean

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  # ============================================
  # STAGE 1: Build Preview APKs (Automatic)
  # ============================================
  build-preview:
    name: ðŸ”¨ Build Preview
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./mobile
        run: npm ci

      - name: ðŸ” Type Check
        working-directory: ./mobile
        run: npx tsc --noEmit --skipLibCheck || echo "Type check completed with warnings"

      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ¤– Build Android APK (Preview)
        working-directory: ./mobile
        run: eas build --platform android --profile preview --non-interactive --no-wait

      - name: ðŸŽ Build iOS (Preview)
        if: github.event_name != 'pull_request'
        working-directory: ./mobile
        run: eas build --platform ios --profile preview --non-interactive --no-wait

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸ“± Mobile Build Started!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "Check build progress at: [Expo Builds](https://expo.dev/accounts/pezkins/projects/intok/builds)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was built:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android APK (preview)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… iOS (preview)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Once complete, download APKs from Expo dashboard for testing." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 2: Deploy to Stores (Manual Trigger)
  # ============================================
  deploy-to-stores:
    name: ðŸš€ Deploy to Stores
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_to_stores == 'true'
    needs: build-preview
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./mobile
        run: npm ci

      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ¤– Build & Submit to Play Store
        working-directory: ./mobile
        run: eas build --platform android --profile production --non-interactive --auto-submit

      - name: ðŸŽ Build & Submit to TestFlight
        working-directory: ./mobile
        run: eas build --platform ios --profile production --non-interactive --auto-submit

      - name: ðŸ“‹ Deployment Summary
        run: |
          echo "## ðŸš€ Store Deployment Initiated!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Android (Play Store)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Building AAB and submitting to Internal Testing track" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Check status: [Google Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### iOS (TestFlight)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Building IPA and submitting to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Check status: [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
