name: ðŸ“± Mobile App CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'mobile/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'apk'
        type: choice
        options:
          - apk
          - aab
      deploy_to_stores:
        description: 'Deploy to Play Store & TestFlight'
        required: false
        default: false
        type: boolean

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  # ============================================
  # Build Android Locally (No EAS cloud limits!)
  # ============================================
  build-android:
    name: ðŸ¤– Build Android
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./mobile
        run: npm install --legacy-peer-deps

      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ” Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ—ï¸ Build APK (Local)
        if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == ''
        working-directory: ./mobile
        run: |
          eas build --platform android --profile preview --local --output ./build/intok.apk --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ—ï¸ Build AAB (Local)
        if: github.event.inputs.build_type == 'aab'
        working-directory: ./mobile
        run: |
          eas build --platform android --profile production --local --output ./build/intok.aab --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¤ Upload APK Artifact
        if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == ''
        uses: actions/upload-artifact@v4
        with:
          name: intok-apk
          path: mobile/build/intok.apk
          retention-days: 30

      - name: ðŸ“¤ Upload AAB Artifact
        if: github.event.inputs.build_type == 'aab'
        uses: actions/upload-artifact@v4
        with:
          name: intok-aab
          path: mobile/build/intok.aab
          retention-days: 30

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸ“± Android Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Output" >> $GITHUB_STEP_SUMMARY
          echo "- Build type: ${{ github.event.inputs.build_type || 'apk' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Download from **Artifacts** section below" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Stores (Manual Trigger)
  # ============================================
  deploy-to-stores:
    name: ðŸš€ Deploy to Stores
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_to_stores == 'true'
    needs: build-android
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download AAB
        uses: actions/download-artifact@v4
        with:
          name: intok-aab
          path: ./build

      - name: ðŸš€ Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.intokapp.app
          releaseFiles: ./build/intok.aab
          track: internal
          status: completed
