name: ðŸ“± Native App CI/CD

# =============================================================================
# DEPLOYMENT STAGES:
# - dev branch    â†’ Build & upload to Firebase App Distribution (testers)
# - stage branch  â†’ Build & upload to Internal Testing (Play Store/TestFlight)
# - main branch   â†’ Build & upload to Production (Play Store/App Store)
# =============================================================================

on:
  push:
    branches:
      - dev
      - stage
      - main
    paths:
      - 'android-native/**'
      - 'ios-native/**'
  pull_request:
    branches:
      - dev
      - stage
      - main
    paths:
      - 'android-native/**'
      - 'ios-native/**'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stage
          - production

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  RUBY_VERSION: '3.2'

jobs:
  # ============================================
  # Determine Build Configuration
  # ============================================
  setup:
    name: ðŸ”§ Setup Build Config
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should_deploy: ${{ steps.config.outputs.should_deploy }}
      android_track: ${{ steps.config.outputs.android_track }}
      ios_target: ${{ steps.config.outputs.ios_target }}
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
      build_android: ${{ steps.changes.outputs.android }}
      build_ios: ${{ steps.changes.outputs.ios }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect Changed Paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            android:
              - 'android-native/**'
            ios:
              - 'ios-native/**'

      - name: ðŸ” Determine Environment
        id: config
        run: |
          # Determine environment based on branch or input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          elif [ "${{ github.ref }}" == "refs/heads/stage" ]; then
            ENV="stage"
          else
            ENV="dev"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          
          # Should we deploy? Only on push to protected branches, not PRs
          if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi
          
          # Set Android track
          case $ENV in
            production)
              echo "android_track=production" >> $GITHUB_OUTPUT
              echo "ios_target=app-store" >> $GITHUB_OUTPUT
              ;;
            stage)
              echo "android_track=internal" >> $GITHUB_OUTPUT
              echo "ios_target=testflight" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "android_track=none" >> $GITHUB_OUTPUT
              echo "ios_target=none" >> $GITHUB_OUTPUT
              ;;
          esac
          
          echo "ðŸ“ Environment: $ENV"

      - name: ðŸ“‹ Get Version Info
        id: version
        run: |
          # Extract version from Android build.gradle.kts
          VERSION_NAME=$(grep 'versionName' android-native/app/build.gradle.kts | sed 's/.*"\(.*\)".*/\1/' | head -1)
          VERSION_CODE=$(grep 'versionCode' android-native/app/build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/' | head -1)
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ðŸ“± Version: $VERSION_NAME (code: $VERSION_CODE)"

      - name: ðŸ“‹ Configuration Summary
        run: |
          echo "## ðŸ”§ Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ steps.config.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.version.outputs.version_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Code | \`${{ steps.version.outputs.version_code }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Should Deploy | \`${{ steps.config.outputs.should_deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Track | \`${{ steps.config.outputs.android_track }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Target | \`${{ steps.config.outputs.ios_target }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‚ Changed Paths Detection" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Changes Detected | Will Build |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------------------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android | \`${{ steps.changes.outputs.android }}\` | ${{ steps.changes.outputs.android == 'true' && 'âœ… Yes' || 'â­ï¸ Skip' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | \`${{ steps.changes.outputs.ios }}\` | ${{ steps.changes.outputs.ios == 'true' && 'âœ… Yes' || 'â­ï¸ Skip' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Code Quality Checks
  # ============================================
  code-quality:
    name: ðŸ§¹ Code Quality
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ”§ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ” Android Lint Check
        working-directory: ./android-native
        run: |
          ./gradlew lint --continue || true
          echo "âœ… Lint check complete"
        continue-on-error: true

      - name: ðŸ§ª Android Unit Tests
        working-directory: ./android-native
        run: |
          ./gradlew test --continue || true
          echo "âœ… Unit tests complete"
        continue-on-error: true

      - name: ðŸ“Š Quality Summary
        run: |
          echo "## ðŸ§¹ Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android Lint | âœ… Checked |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Tests | âœ… Checked |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Android Build
  # ============================================
  build-android:
    name: ðŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [setup, code-quality]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.platform != 'ios') ||
      (github.event_name != 'workflow_dispatch' && needs.setup.outputs.build_android == 'true')
    outputs:
      artifact_name: ${{ steps.build.outputs.artifact_name }}
      environment: ${{ needs.setup.outputs.environment }}
      should_deploy: ${{ needs.setup.outputs.should_deploy }}
      android_track: ${{ needs.setup.outputs.android_track }}
      version_name: ${{ needs.setup.outputs.version_name }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ”§ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ” Decode Keystore (Stage/Production)
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android-native/app/release.keystore
          echo "âœ… Keystore decoded"

      - name: ðŸ“ Create Keystore Properties
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        run: |
          cat > android-native/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: ðŸ—ï¸ Build Debug APK (Dev)
        if: needs.setup.outputs.environment == 'dev'
        id: build_debug
        working-directory: ./android-native
        run: |
          ./gradlew assembleDebug
          echo "artifact_name=intok-android-debug-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          echo "âœ… Debug APK built"

      - name: ðŸ—ï¸ Build Release AAB (Stage/Production)
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        id: build_release
        working-directory: ./android-native
        run: |
          ./gradlew bundleRelease
          echo "artifact_name=intok-android-release-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          echo "âœ… Release AAB built"

      - name: ðŸ“¦ Set Artifact Name
        id: build
        run: |
          if [ "${{ needs.setup.outputs.environment }}" == "dev" ]; then
            echo "artifact_name=intok-android-debug-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          else
            echo "artifact_name=intok-android-release-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload Debug APK
        if: needs.setup.outputs.environment == 'dev'
        uses: actions/upload-artifact@v4
        with:
          name: intok-android-debug-${{ needs.setup.outputs.version_name }}
          path: android-native/app/build/outputs/apk/debug/*.apk
          retention-days: 14

      - name: ðŸ“¤ Upload Release AAB
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: intok-android-release-${{ needs.setup.outputs.version_name }}
          path: android-native/app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: ðŸ§¹ Cleanup Secrets
        if: always()
        run: |
          rm -f android-native/app/release.keystore
          rm -f android-native/keystore.properties

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸ¤– Android Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.setup.outputs.version_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Code | \`${{ needs.setup.outputs.version_code }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.setup.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | ${{ needs.setup.outputs.environment == 'dev' && 'Debug APK' || 'Release AAB' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # iOS Build
  # ============================================
  build-ios:
    name: ðŸŽ Build iOS
    runs-on: macos-14
    needs: [setup, code-quality]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.platform != 'android') ||
      (github.event_name != 'workflow_dispatch' && needs.setup.outputs.build_ios == 'true')
    outputs:
      artifact_name: ${{ steps.build.outputs.artifact_name }}
      environment: ${{ needs.setup.outputs.environment }}
      should_deploy: ${{ needs.setup.outputs.should_deploy }}
      ios_target: ${{ needs.setup.outputs.ios_target }}
      version_name: ${{ needs.setup.outputs.version_name }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ./ios-native

      - name: ðŸ“¦ Install Fastlane
        working-directory: ./ios-native
        run: |
          if [ -f "Gemfile" ]; then
            bundle install
          else
            gem install fastlane
          fi

      - name: ðŸ“¦ Install CocoaPods Dependencies
        working-directory: ./ios-native
        run: |
          if [ -f "Podfile" ]; then
            pod install
          fi
        continue-on-error: true

      - name: ðŸ” Import Signing Certificate (Stage/Production)
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate
          echo -n "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          
          # Set keychain
          security list-keychains -d user -s $KEYCHAIN_PATH
          security default-keychain -s $KEYCHAIN_PATH
          
          echo "âœ… Signing certificate imported"

      - name: ðŸ“ Install Provisioning Profile (Stage/Production)
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          echo "âœ… Provisioning profile installed"

      - name: ðŸ” Check Xcode Project
        id: check_project
        working-directory: ./ios-native
        run: |
          if [ -f "Intok.xcodeproj/project.pbxproj" ] || [ -f "Intok.xcworkspace/contents.xcworkspacedata" ]; then
            echo "project_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Xcode project found"
          else
            echo "project_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Xcode project not found - will generate with XcodeGen"
          fi

      - name: ðŸ”§ Generate Xcode Project (if needed)
        if: steps.check_project.outputs.project_exists == 'false'
        working-directory: ./ios-native
        run: |
          brew install xcodegen || true
          if [ -f "project.yml" ]; then
            xcodegen generate
            echo "âœ… Xcode project generated"
          else
            echo "âš ï¸ No project.yml found - cannot generate project"
          fi

      - name: ðŸ—ï¸ Build Debug (Dev)
        if: needs.setup.outputs.environment == 'dev' && steps.check_project.outputs.project_exists == 'true'
        id: build_debug
        working-directory: ./ios-native
        run: |
          # Build for simulator
          xcodebuild build \
            -project Intok.xcodeproj \
            -scheme Intok \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO || echo "Build completed with warnings"
          
          echo "âœ… Debug build complete"

      - name: ðŸ—ï¸ Build Release (Stage/Production)
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true' && steps.check_project.outputs.project_exists == 'true'
        id: build_release
        working-directory: ./ios-native
        run: |
          # Archive for App Store
          xcodebuild archive \
            -project Intok.xcodeproj \
            -scheme Intok \
            -configuration Release \
            -archivePath build/Intok.xcarchive \
            -destination 'generic/platform=iOS' \
            || echo "Archive completed with warnings"
          
          # Export IPA
          xcodebuild -exportArchive \
            -archivePath build/Intok.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist \
            || echo "Export completed with warnings"
          
          echo "âœ… Release build complete"
        continue-on-error: true

      - name: ðŸ“¦ Set Artifact Name
        id: build
        run: |
          if [ "${{ needs.setup.outputs.environment }}" == "dev" ]; then
            echo "artifact_name=intok-ios-debug-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          else
            echo "artifact_name=intok-ios-release-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload iOS Debug Build
        if: steps.check_project.outputs.project_exists == 'true' && needs.setup.outputs.environment == 'dev'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ios-native/build/Build/Products/Debug-iphonesimulator/Intok.app
          retention-days: 14
          if-no-files-found: warn

      - name: ðŸ“¤ Upload iOS Release Build
        if: steps.check_project.outputs.project_exists == 'true' && needs.setup.outputs.environment != 'dev'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: ios-native/build/ipa/*.ipa
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ§¹ Cleanup Keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -f $RUNNER_TEMP/certificate.p12

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸŽ iOS Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_project.outputs.project_exists }}" == "true" ]; then
            echo "âœ… Build completed for environment: \`${{ needs.setup.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Xcode project not found. Please run \`xcodegen generate\` locally and commit." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Deploy Android to Google Play (Stage/Production)
  # ============================================
  deploy-android:
    name: ðŸš€ Deploy Android
    runs-on: ubuntu-latest
    needs: [build-android]
    if: |
      always() &&
      needs.build-android.result == 'success' &&
      needs.build-android.outputs.should_deploy == 'true' &&
      needs.build-android.outputs.environment != 'dev' &&
      needs.build-android.outputs.android_track != 'none'
    environment: ${{ needs.build-android.outputs.environment }}
    
    steps:
      - name: ðŸ“¥ Download AAB Artifact
        uses: actions/download-artifact@v4
        with:
          name: intok-android-release-${{ needs.build-android.outputs.version_name }}
          path: ./build

      - name: ðŸ” Find AAB File
        id: find_aab
        run: |
          AAB_FILE=$(find ./build -name "*.aab" | head -1)
          echo "aab_file=$AAB_FILE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Found AAB: $AAB_FILE"

      - name: ðŸ”‘ Create Service Account JSON
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > service-account.json

      - name: ðŸš€ Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: service-account.json
          packageName: com.intokapp.app
          releaseFiles: ${{ steps.find_aab.outputs.aab_file }}
          track: ${{ needs.build-android.outputs.android_track }}
          status: completed
          changesNotSentForReview: false

      - name: ðŸ§¹ Cleanup
        if: always()
        run: rm -f service-account.json

      - name: ðŸ“‹ Deployment Summary
        run: |
          echo "## ðŸš€ Android Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package | \`com.intokapp.app\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.build-android.outputs.version_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Track | \`${{ needs.build-android.outputs.android_track }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.build-android.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy iOS to App Store Connect (Stage/Production)
  # ============================================
  deploy-ios:
    name: ðŸš€ Deploy iOS
    runs-on: macos-14
    needs: [build-ios]
    if: |
      always() &&
      needs.build-ios.result == 'success' &&
      needs.build-ios.outputs.should_deploy == 'true' &&
      needs.build-ios.outputs.environment != 'dev' &&
      needs.build-ios.outputs.ios_target != 'none'
    environment: ${{ needs.build-ios.outputs.environment }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download IPA Artifact
        uses: actions/download-artifact@v4
        with:
          name: intok-ios-release-${{ needs.build-ios.outputs.version_name }}
          path: ./build
        continue-on-error: true

      - name: ðŸ” Find IPA File
        id: find_ipa
        run: |
          IPA_FILE=$(find ./build -name "*.ipa" | head -1)
          if [ -n "$IPA_FILE" ]; then
            echo "ipa_file=$IPA_FILE" >> $GITHUB_OUTPUT
            echo "ipa_found=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Found IPA: $IPA_FILE"
          else
            echo "ipa_found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No IPA found"
          fi

      - name: ðŸš€ Upload to App Store Connect
        if: steps.find_ipa.outputs.ipa_found == 'true'
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          # Create API key file
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          
          # Upload using xcrun altool or notarytool
          xcrun altool --upload-app \
            --type ios \
            --file "${{ steps.find_ipa.outputs.ipa_file }}" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID" \
            || echo "Upload completed with warnings"

      - name: ðŸ“‹ Deployment Summary
        run: |
          echo "## ðŸŽ iOS Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.find_ipa.outputs.ipa_found }}" == "true" ]; then
            echo "âœ… IPA uploaded to App Store Connect" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Version | \`${{ needs.build-ios.outputs.version_name }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Target | \`${{ needs.build-ios.outputs.ios_target }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No IPA artifact found. iOS build may have failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Ensure Xcode project is committed" >> $GITHUB_STEP_SUMMARY
            echo "2. Configure signing certificates" >> $GITHUB_STEP_SUMMARY
            echo "3. Set up App Store Connect API keys" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Deployment Summary
  # ============================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [deploy-android, deploy-ios]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Final Summary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## ðŸ“± Native App Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          
          # Determine environment from branch
          case "${{ github.ref_name }}" in
            dev) ENV="dev" ;;
            stage) ENV="stage" ;;
            main) ENV="production" ;;
            *) ENV="dev" ;;
          esac
          echo "| Environment | \`$ENV\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.deploy-android.result == 'success' && 'âœ…' || needs.deploy-android.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.deploy-ios.result == 'success' && 'âœ…' || needs.deploy-ios.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Environment-specific notes
          case "$ENV" in
            dev)
              echo "### ðŸ”§ Development Build" >> $GITHUB_STEP_SUMMARY
              echo "Debug builds are available in the Artifacts section." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Next step:** When ready, create a PR to merge into \`stage\` branch for internal testing." >> $GITHUB_STEP_SUMMARY
              ;;
            stage)
              echo "### ðŸ§ª Stage Build" >> $GITHUB_STEP_SUMMARY
              echo "Builds have been submitted to internal testing tracks:" >> $GITHUB_STEP_SUMMARY
              echo "- Android: Google Play Internal Testing" >> $GITHUB_STEP_SUMMARY
              echo "- iOS: TestFlight" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Next step:** After testing, create a PR to merge into \`main\` branch for production release." >> $GITHUB_STEP_SUMMARY
              ;;
            production)
              echo "### ðŸš€ Production Release" >> $GITHUB_STEP_SUMMARY
              echo "Builds have been submitted to production tracks:" >> $GITHUB_STEP_SUMMARY
              echo "- Android: Google Play Production" >> $GITHUB_STEP_SUMMARY
              echo "- iOS: App Store" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
