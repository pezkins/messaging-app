name: ðŸ¤– Android Native CI/CD

on:
  push:
    branches: [stage, main]
    paths: ['android-native/**']
  pull_request:
    branches: [stage, main]
    paths: ['android-native/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'stage'
        type: choice
        options: [stage, production]

env:
  JAVA_VERSION: '17'

jobs:
  # ============================================
  # Setup & Configuration
  # ============================================
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should_deploy: ${{ steps.config.outputs.should_deploy }}
      track: ${{ steps.config.outputs.track }}
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Determine Environment
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="stage"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

          case $ENV in
            production) echo "track=production" >> $GITHUB_OUTPUT ;;
            *) echo "track=internal" >> $GITHUB_OUTPUT ;;
          esac

      - name: ðŸ“‹ Get Version
        id: version
        run: |
          VERSION_NAME=$(grep 'versionName' android-native/app/build.gradle.kts | sed 's/.*"\(.*\)".*/\1/' | head -1)
          VERSION_CODE=$(grep 'versionCode' android-native/app/build.gradle.kts | sed 's/.*= \([0-9]*\).*/\1/' | head -1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: ðŸ“‹ Summary
        run: |
          echo "## ðŸ¤– Android Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ steps.config.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.version.outputs.version_name }}\` (code: ${{ steps.version.outputs.version_code }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Track | \`${{ steps.config.outputs.track }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | \`${{ steps.config.outputs.should_deploy }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Code Quality
  # ============================================
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ”§ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ” Run Lint
        working-directory: ./android-native
        env:
          GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
          TENOR_API_KEY: ${{ secrets.TENOR_API_KEY }}
          GIPHY_API_KEY: ${{ secrets.GIPHY_API_KEY }}
        run: ./gradlew lint

  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ”§ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ§ª Run Tests
        working-directory: ./android-native
        env:
          GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
          TENOR_API_KEY: ${{ secrets.TENOR_API_KEY }}
          GIPHY_API_KEY: ${{ secrets.GIPHY_API_KEY }}
        run: ./gradlew test

  # ============================================
  # Build
  # ============================================
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [setup, lint, test]
    outputs:
      artifact_name: ${{ steps.artifact.outputs.name }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ”§ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ” Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android-native/app/release.keystore

      - name: ðŸ“ Create Keystore Properties
        run: |
          cat > android-native/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: ðŸ—ï¸ Build Debug APK
        if: needs.setup.outputs.environment == 'dev'
        working-directory: ./android-native
        env:
          GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
          TENOR_API_KEY: ${{ secrets.TENOR_API_KEY }}
          GIPHY_API_KEY: ${{ secrets.GIPHY_API_KEY }}
        run: ./gradlew assembleDebug

      - name: ðŸ—ï¸ Build Release AAB
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        working-directory: ./android-native
        env:
          GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
          TENOR_API_KEY: ${{ secrets.TENOR_API_KEY }}
          GIPHY_API_KEY: ${{ secrets.GIPHY_API_KEY }}
        run: ./gradlew bundleRelease

      - name: ðŸ“¦ Set Artifact Name
        id: artifact
        run: |
          if [ "${{ needs.setup.outputs.environment }}" == "dev" ]; then
            echo "name=android-debug-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=android-release-${{ needs.setup.outputs.version_name }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload Debug APK
        if: needs.setup.outputs.environment == 'dev'
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-${{ needs.setup.outputs.version_name }}
          path: android-native/app/build/outputs/apk/debug/*.apk
          retention-days: 14

      - name: ðŸ“¤ Upload Release AAB
        if: needs.setup.outputs.environment != 'dev' && needs.setup.outputs.should_deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ needs.setup.outputs.version_name }}
          path: android-native/app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f android-native/app/release.keystore
          rm -f android-native/keystore.properties

  # ============================================
  # Deploy
  # ============================================
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      needs.setup.outputs.should_deploy == 'true' &&
      needs.setup.outputs.environment != 'dev' &&
      needs.setup.outputs.track != 'none'
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: ðŸ“¥ Download AAB
        uses: actions/download-artifact@v4
        with:
          name: android-release-${{ needs.setup.outputs.version_name }}
          path: ./build

      - name: âœ… Verify Download
        run: |
          if [ ! -d "./build" ]; then
            echo "âŒ Download failed - build directory does not exist"
            exit 1
          fi
          echo "âœ… Download directory exists"
          ls -la ./build

      - name: ðŸ” Find AAB
        id: find_aab
        run: |
          AAB_FILE=$(find ./build -name "*.aab" 2>/dev/null | head -1)
          if [ -z "$AAB_FILE" ]; then
            echo "âŒ No AAB file found in ./build"
            find ./build -type f 2>/dev/null || echo "No files found"
            exit 1
          fi
          echo "aab_file=$AAB_FILE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Found: $AAB_FILE"

      - name: ðŸ”‘ Create Service Account
        run: echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > service-account.json

      - name: ðŸš€ Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: service-account.json
          packageName: com.intokapp.app
          releaseFiles: ${{ steps.find_aab.outputs.aab_file }}
          track: ${{ needs.setup.outputs.track }}
          status: draft

      - name: ðŸ§¹ Cleanup
        if: always()
        run: rm -f service-account.json

      - name: ðŸ“‹ Summary
        run: |
          echo "## ðŸš€ Android Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package | \`com.intokapp.app\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.setup.outputs.version_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Track | \`${{ needs.setup.outputs.track }}\` |" >> $GITHUB_STEP_SUMMARY


